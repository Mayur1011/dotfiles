#!/bin/sh

# Battery notifications without temp files
# Uses threshold-crossing detection

export DISPLAY=:0
export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/1000/bus"

WARNING_LEVEL=40
CRITICAL_LEVEL=20

BATTERY_INFO=$(acpi -b | grep "Battery 0")
BATTERY_DISCHARGING=$(echo "$BATTERY_INFO" | grep -c "Discharging")
BATTERY_LEVEL=$(echo "$BATTERY_INFO" | grep -o '[0-9]\+%')
BATTERY_LEVEL=${BATTERY_LEVEL%\%}

# Store last known battery level
STATE_FILE="$HOME/.cache/battery_last_level"

LAST_LEVEL=100
[ -f "$STATE_FILE" ] && LAST_LEVEL=$(cat "$STATE_FILE")

echo "Battery Level: $BATTERY_LEVEL%, Discharging: $BATTERY_DISCHARGING (Last: $LAST_LEVEL%)"

# Save current level for next run
echo "$BATTERY_LEVEL" > "$STATE_FILE"

# Only notify while discharging
[ "$BATTERY_DISCHARGING" -ne 1 ] && exit 0

# Fully charged notification (crossing 100% while charging is ignored here)

# Critical threshold crossed
if [ "$BATTERY_LEVEL" -le "$CRITICAL_LEVEL" ]; then
    echo "Sending critical battery notification"
    notify-send "Battery Critical" \
        "The computer will shut down soon." \
        -u critical -r 9991 -t 5000
    exit 0
fi

# Warning threshold crossed
if [ "$BATTERY_LEVEL" -le "$WARNING_LEVEL" ]; then
    echo "Sending low battery notification"
    notify-send "Low Battery" \
        "${BATTERY_LEVEL}% of battery remaining." \
        -u normal -r 9991 -t 5000
fi

